# T√™n c·ªßa quy tr√¨nh CI/CD
name: Laravel CI/CD with Newman Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # B∆∞·ªõc 1: L·∫•y code t·ª´ repository v·ªÅ
      - name: Checkout Code
        uses: actions/checkout@v4

      # B∆∞·ªõc 2: T·∫°o file .env t·ª´ template v√† secrets
      - name: Create Laravel .env file üîß
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "üîß Creating Laravel .env file from .env.ci template..."
          # L·ªánh envsubst s·∫Ω ƒë·ªçc file .env.ci, t√¨m c√°c bi·∫øn $VAR v√† thay b·∫±ng gi√° tr·ªã t·ª´ secrets
          envsubst < sprint5-with-bugs/API/.env.ci > sprint5-with-bugs/API/.env
          echo " .env file created successfully."

      # B∆∞·ªõc 3: Kh·ªüi ƒë·ªông c√°c container Docker
      - name: Start Docker Containers
        run: docker compose up -d

      # B∆∞·ªõc 4: Ch·ªù c√°c d·ªãch v·ª• s·∫µn s√†ng
      - name: Wait for Services
        run: sleep 60
        shell: bash

      # B∆∞·ªõc 5: C√†i ƒë·∫∑t c√°c th∆∞ vi·ªán v√† thi·∫øt l·∫≠p ·ª©ng d·ª•ng
      - name: Setup Application üîß
        run: |
          echo " Installing Composer dependencies..."
          # S·ª≠ d·ª•ng service 'composer' ƒë√£ ƒë·ªãnh nghƒ©a trong docker-compose.yml
          docker compose run --rm composer

          echo " Fixing permissions..."
          # G√°n quy·ªÅn truy c·∫≠p cho th∆∞ m·ª•c storage v√† cache
          docker compose exec -T -u root laravel-api chown -R www-data:www-data /var/www/storage /var/www/bootstrap/cache

          echo " Running database migrations and seeding..."
          # Ch·∫°y migrate & seed
          docker compose exec -T laravel-api php artisan migrate:fresh --seed --force

      # B∆∞·ªõc 6: C√†i ƒë·∫∑t Node.js v√† Newman
      - name: Install Node.js & Newman ‚öôÔ∏è
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - run: npm install -g newman newman-reporter-htmlextra

      # B∆∞·ªõc 7: Ch·∫°y ki·ªÉm th·ª≠ Newman
      - name: Run Newman tests
        run: newman run 'tests/api/login-tests.postman_collection.json' -e 'tests/api/environment.json' --reporters cli,htmlextra --reporter-htmlextra-export newman-report.html

      # B∆∞·ªõc 8: Upload b√°o c√°o (lu√¥n ch·∫°y)
      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: newman-report
          path: newman-report.html

      # B∆∞·ªõc 9: D·ªçn d·∫πp (lu√¥n ch·∫°y)
      - name: Cleanup
        if: always()
        run: docker compose down -v
